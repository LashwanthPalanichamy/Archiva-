<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESEC Admin Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <style>
        :root {
            --theme-primary: #f43a09;
            --theme-secondary: #ffb766;
            --theme-accent: #68d388;
            --theme-light-accent: #c2edda;
            --theme-bg-light: #FFFFFF;
            --theme-bg-medium: #f8f9fa;
            --text-dark: #212529;
            --border-color: #dee2e6;
            --glow-color: rgba(244, 58, 9, 0.6);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background-color: var(--theme-bg-medium); color: var(--text-dark); overflow-x: hidden; }
        .sidebar { width: 260px; background: var(--theme-bg-light); border-right: 1px solid var(--border-color); position: fixed; top: 0; left: 0; height: 100vh; z-index: 1001; transform: translateX(-100%); transition: transform 0.4s ease; }
        .sidebar.active { transform: translateX(0); }
        .sidebar-header { padding: 20px; display: flex; justify-content: space-between; align-items: center; font-size: 1.5rem; font-weight: 600; color: var(--theme-primary); border-bottom: 1px solid var(--border-color); }
        .sidebar-header .close-btn { font-size: 1.8rem; cursor: pointer; }
        .sidebar-menu { list-style: none; padding-top: 20px; }
        .sidebar-menu li a { display: flex; align-items: center; padding: 15px 25px; color: var(--text-dark); text-decoration: none; font-size: 1.1rem; border-left: 4px solid transparent; transition: all 0.3s; }
        .sidebar-menu li a:hover, .sidebar-menu li a.active { background-color: #f1f1f1; border-left-color: var(--theme-primary); color: var(--theme-primary); }
        .sidebar-menu li a i { margin-right: 15px; width: 20px; }
        .header { background-color: var(--theme-bg-light); padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); position: sticky; top: 0; z-index: 999; }
        .hamburger-menu { font-size: 1.5rem; cursor: pointer; }
        .college-title { display: flex; align-items: center; gap: 15px; position: absolute; left: 50%; transform: translateX(-50%); }
        .college-title img { width: 45px; height: 45px; }
        .college-title h1 { font-size: 1.3rem; font-weight: 600; white-space: nowrap; }
        .header-right { display: flex; align-items: center; gap: 25px; }
        .profile-container { position: relative; cursor: pointer; display: flex; align-items: center; gap: 10px; }
        .profile-dropdown { position: absolute; top: 120%; right: 0; background-color: var(--theme-bg-light); border-radius: 8px; overflow: hidden; width: 180px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); transform: translateY(10px); opacity: 0; visibility: hidden; transition: all 0.3s ease; }
        .profile-dropdown.active { transform: translateY(0); opacity: 1; visibility: visible; }
        .profile-dropdown a { display: flex; align-items: center; padding: 12px 15px; text-decoration: none; color: var(--text-dark); }
        .profile-dropdown a i { margin-right: 10px; }
        .profile-dropdown a:hover { background-color: var(--theme-light-accent); }
        .main-content { transition: margin-left 0.4s ease; }
        .sidebar.active ~ .main-content { margin-left: 260px; }
        .page-content { padding: 30px; }
        .page { display: none; } .page.active { display: block; }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .action-cards-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 30px; margin-top: 20px; }
        .action-card { background: var(--theme-bg-light); padding: 30px; border-radius: 15px; text-align: center; cursor: pointer; transition: all 0.3s ease; border: 1px solid var(--border-color); }
        .action-card:hover { transform: translateY(-10px); box-shadow: 0 0 25px -5px var(--glow-color); }
        .action-card .icon { font-size: 3.5rem; margin-bottom: 20px; color: var(--theme-primary); }
        .action-card h3 { font-size: 1.3rem; font-weight: 500; }
        .btn-primary { display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px; background-color: var(--theme-primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 500; transition: background-color 0.3s, transform 0.2s; }
        .btn-primary:hover { background-color: #d32f00; transform: scale(1.05); }
        .back-button { cursor: pointer; font-weight: 500; display: inline-flex; align-items: center; gap: 5px; transition: transform 0.3s ease; }
        .back-button:hover { transform: translateX(-5px); color: var(--theme-primary); }
        .form-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1002; display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; transition: all 0.3s; }
        .form-modal.active { opacity: 1; visibility: visible; }
        .form-modal-content { background-color: var(--theme-bg-light); padding: 30px; border-radius: 15px; width: 90%; max-width: 900px; max-height: 90vh; overflow-y: auto; position: relative; transform: scale(0.9); transition: all 0.3s; }
        .form-modal.active .form-modal-content { transform: scale(1); }
        .form-modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .form-modal-header .close-form-btn { font-size: 1.8rem; cursor: pointer; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { margin-bottom: 5px; font-weight: 500; }
        .form-group input, .form-group select { padding: 10px; border: 1px solid var(--border-color); border-radius: 5px; }
        .form-actions { margin-top: 30px; text-align: right; }
        .btn-save { background-color: var(--theme-accent); }
        .btn-edit { background-color: var(--theme-secondary); color: var(--text-dark); }
        .data-table-container { background: #fff; border-radius: 10px; padding: 20px; overflow-x: auto; margin-top: 20px; }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th, .data-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
        .data-table th { background-color: var(--theme-bg-medium); font-weight: 600; }
        #headerProfilePic { width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--theme-primary); object-fit: cover; }
        .action-icons i { cursor: pointer; margin: 0 8px; font-size: 1.1rem; transition: color 0.3s, transform 0.2s; }
        .action-icons i:hover { transform: scale(1.2); }
        .action-icons .fa-edit { color: var(--theme-secondary); }
        .action-icons .fa-trash-alt { color: var(--theme-primary); }
        .close-btn, .close-form-btn { transition: transform 0.4s ease, color 0.3s ease; }
        .close-btn:hover, .close-form-btn:hover { transform: rotate(180deg); color: var(--theme-primary); }
        .hamburger-menu { transition: color 0.3s ease, transform 0.3s ease; }
        .hamburger-menu:hover { transform: scale(1.1); color: var(--theme-primary); }
        #userProfileForm { background: #fff; padding: 30px; border-radius: 10px; }
        .profile-grid { display: grid; grid-template-columns: 200px 1fr; gap: 30px; align-items: start; }
        .profile-picture-section { text-align: center; }
        .profile-picture-section img { width: 150px; height: 150px; border-radius: 50%; border: 4px solid var(--theme-primary); margin-bottom: 15px; object-fit: cover; }
        .profile-picture-section input[type="file"] { display: none; }
        .profile-picture-section .btn-upload { background-color: var(--theme-light-accent); color: var(--text-dark); }
        .profile-fields-section input[readonly] { background-color: #e9ecef; cursor: not-allowed; }
        .staff-grid-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .staff-card { background: #fff; border-radius: 10px; padding: 20px; text-align: center; cursor: pointer; transition: transform 0.3s ease, box-shadow 0.3s ease; border: 1px solid var(--border-color); }
        .staff-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .staff-card i { font-size: 2.5rem; color: var(--theme-primary); margin-bottom: 15px; }
        .staff-card h4 { font-size: 1.2rem; font-weight: 600; }
        .staff-card p { color: #6c757d; }
        .timetable-details-container h2 { font-size: 1.5rem; margin-bottom: 10px; }
    </style>
</head>
<body>
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header"> ESEC Admin <i class="fas fa-times close-btn" id="close-sidebar-btn"></i></div>
        <ul class="sidebar-menu">
            <li><a href="#" class="nav-link active" data-page="home"><i class="fas fa-home"></i> Home</a></li>
            <li><a href="#" class="nav-link" data-page="manage-students"><i class="fas fa-user-graduate"></i> Students</a></li>
            <li><a href="#" class="nav-link" data-page="manage-staff"><i class="fas fa-chalkboard-teacher"></i> Staff</a></li>
            <li><a href="#" class="nav-link" data-page="manage-timetables"><i class="fas fa-calendar-alt"></i> Timetables</a></li>
        </ul>
    </nav>
    <div class="main-content">
        <header class="header">
            <i class="fas fa-bars hamburger-menu" id="hamburger-menu"></i>
            <div class="college-title">
                <img src="/uploads/1st.jpg" alt="ESEC Logo">
                <h1>ERODE SENGUNTHAR ENGINEERING COLLEGE</h1>
            </div>
            <div class="header-right">
                <div class="profile-container" id="profile-container">
                    <img src="https://i.pravatar.cc/150?u=admin" alt="Admin Photo" id="headerProfilePic">
                    <div class="profile-dropdown" id="profile-dropdown">
                        <a href="#" class="nav-link" data-page="user-profile"><i class="fas fa-user-edit"></i> User Profile</a>
                        <a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</a>
                    </div>
                </div>
            </div>
        </header>
        <main class="page-content" id="page-content">
            <div id="home" class="page active">
                <div class="page-header"> <h2 id="welcomeMessage">Welcome back, Admin</h2> </div>
                <div class="action-cards-container">
                   <div class="action-card nav-link" data-page="manage-students"> <div class="icon"><i class="fas fa-user-graduate"></i></div> <h3>Manage Students</h3> </div>
                   <div class="action-card nav-link" data-page="manage-staff"> <div class="icon"><i class="fas fa-chalkboard-teacher"></i></div> <h3>Manage Staff</h3> </div>
                   <div class="action-card nav-link" data-page="manage-timetables"> <div class="icon"><i class="fas fa-calendar-alt"></i></div> <h3>Manage Timetables</h3> </div>
                </div>
            </div>
            
            <div id="manage-timetables" class="page">
                <div id="staffSelectionView">
                    <div class="page-header">
                        <span class="back-button nav-link" data-page="home"><i class="fas fa-arrow-left"></i> Back</span>
                        <h2>Select a Staff Member</h2>
                    </div>
                    <div class="staff-grid-container" id="staffGridForTimetable"></div>
                </div>
                <div id="timetableDetailsView" style="display: none;">
                    <div class="page-header">
                        <span class="back-button" id="backToStaffListBtn"><i class="fas fa-arrow-left"></i> Back to Staff List</span>
                        <h2 id="selectedStaffName"></h2>
                        <button class="btn-primary btn-new-timetable" id="newTimetableBtn"><i class="fas fa-plus"></i> New Class Period</button>
                    </div>
                    <div class="data-table-container" id="weeklyTimetableContainer"></div>
                </div>
            </div>

            <div id="manage-students" class="page">
                <div class="page-header">
                    <span class="back-button nav-link" data-page="home"><i class="fas fa-arrow-left"></i> Back</span>
                    <h2>Student Management</h2>
                    <button class="btn-primary" id="newStudentBtn"><i class="fas fa-plus"></i> New Student</button>
                </div>
                <div class="data-table-container" id="studentListContainer"></div>
            </div>

            <div id="manage-staff" class="page">
                <div class="page-header">
                    <span class="back-button nav-link" data-page="home"><i class="fas fa-arrow-left"></i> Back</span>
                    <h2>Staff Management</h2>
                    <button class="btn-primary" id="newStaffBtn"><i class="fas fa-plus"></i> New Staff</button>
                </div>
                <div class="data-table-container" id="staffListContainer"></div>
            </div>

            <div id="user-profile" class="page">
                <div class="page-header">
                       <span class="back-button nav-link" data-page="home"><i class="fas fa-arrow-left"></i> Back</span>
                    <h2>Edit User Profile</h2>
                    <div class="form-actions">
                        <button class="btn-primary btn-edit" id="editProfileBtn"><i class="fas fa-edit"></i> Edit</button>
                        <button class="btn-primary btn-save" id="saveProfileBtn" style="display: none;"><i class="fas fa-save"></i> Save Changes</button>
                    </div>
                </div>
                <div id="userProfileFormContainer"></div>
            </div>
        </main>
    </div>

    <div class="form-modal" id="studentFormModal">
        <div class="form-modal-content">
            <div class="form-modal-header"> <h2 id="studentModalTitle">New Student Entry</h2> <i class="fas fa-times close-form-btn"></i> </div>
            <form id="studentForm">
                <input type="hidden" id="studentId" name="studentId">
                <div class="form-grid">
                    <div class="form-group"><label>Student Name</label><input type="text" name="student_name" required></div>
                    <div class="form-group"><label>Register Number</label><input type="text" name="register_number" required></div>
                    <div class="form-group"><label>Roll Number</label><input type="text" name="roll_number" required></div>
                    <div class="form-group"><label>Year of Study</label><select name="year_of_study"><option>1st Year</option><option>2nd Year</option><option>3rd Year</option><option>4th Year</option></select></div>
                    <div class="form-group"><label>Department</label>
                        <select name="department">
                            <option>Artificial Intelligence & Data Science</option><option>Automobile Engineering</option><option>Biomedical Engineering</option><option>Biotechnology</option><option>Chemical Engineering</option><option>Civil Engineering</option><option>Computer Science and Engineering</option><option>Electrical and Electronics Engineering</option><option>Electronics and Communication Engineering</option><option>Food Technology</option><option>Information Technology</option><option>Mechanical Engineering</option><option>Mechatronics</option><option>Placement</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Section</label><select name="section"><option>A</option><option>B</option><option>C</option><option>D</option></select></div>
                    <div class="form-group"><label>Semester</label><select name="semester"><option>Odd</option><option>Even</option></select></div>
                    <div class="form-group"><label>From Year</label><input type="number" name="from_year" placeholder="2022"></div>
                    <div class="form-group"><label>To Year</label><input type="number" name="to_year" placeholder="2026"></div>
                </div>
                <div class="form-actions"><button type="submit" class="btn-primary btn-save">Save Student</button></div>
            </form>
        </div>
    </div>
    
    <div class="form-modal" id="staffFormModal">
        <div class="form-modal-content">
            <div class="form-modal-header"> <h2 id="staffModalTitle">New Staff Entry</h2> <i class="fas fa-times close-form-btn"></i></div>
            <form id="staffForm">
                <input type="hidden" id="staffId" name="staffId">
                <div class="form-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                    <div class="form-group"><label>Prefix</label><select name="prefix"><option>Dr.</option><option>Mr.</option><option>Ms.</option><option>Mrs.</option></select></div>
                    <div class="form-group"><label>First Name</label><input type="text" name="first_name" required></div>
                    <div class="form-group"><label>Last Name</label><input type="text" name="last_name"></div>
                    <div class="form-group"><label>Gender</label><select name="gender"><option>MALE</option><option>FEMALE</option><option>OTHERS</option></select></div>
                    <div class="form-group"><label>Date of Birth</label><input type="date" name="date_of_birth"></div>
                    <div class="form-group"><label>Blood Group</label><select name="blood_group"><option>O+</option><option>O-</option><option>A+</option><option>A-</option><option>B+</option><option>B-</option><option>AB+</option><option>AB-</option></select></div>
                    <div class="form-group"><label>Mobile Number</label><input type="tel" name="mobile_number"></div>
                    <div class="form-group"><label>Email</label><input type="email" name="email" required></div>
                    <div class="form-group"><label>Marital Status</label><select name="marital_status"><option>MARRIED</option><option>UNMARRIED</option></select></div>
                    <div class="form-group"><label>Alternative Mobile Number</label><input type="tel" name="alternative_mobile_number"></div>
                    <div class="form-group"><label>Alternative Email</label><input type="email" name="alternative_email"></div>
                    <div class="form-group"><label>Aadhaar Number</label><input type="text" name="aadhaar_number"></div>
                    <div class="form-group"><label>Religion</label><input type="text" name="religion"></div>
                    <div class="form-group"><label>Mother Tongue</label><input type="text" name="mother_tongue"></div>
                    <div class="form-group"><label>Nationality</label><input type="text" name="nationality" value="INDIAN"></div>
                    <div class="form-group"><label>State</label><select name="state"><option>TAMIL NADU</option></select></div>
                    <div class="form-group"><label>Profile Status</label><select name="profile_status"><option>ACTIVE</option><option>INACTIVE</option></select></div>
                    <div class="form-group"><label>Department</label>
                        <select name="department">
                            <option>Aeronautical Engineering</option><option>Artificial Intelligence & Data Science</option><option>Automobile Engineering</option><option>Biomedical Engineering</option><option>Biotechnology</option><option>Chemical Engineering</option><option>Civil Engineering</option><option>Computer Science and Engineering</option><option>Electrical and Electronics Engineering</option><option>Electronics and Communication Engineering</option><option>Food Technology</option><option>Information Technology</option><option>Mechanical Engineering</option><option>Mechatronics</option><option>Administration</option><option>Placement</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Username</label><input type="text" name="user_name" placeholder="Same as email usually"></div>
                    <div class="form-group"><label>Password</label><input type="password" name="password" required></div>
                    <div class="form-group"><label>Role</label><select name="role"><option>Staff</option><option>HOD</option><option>Admin</option></select></div>
                </div>
                <div class="form-actions"><button type="submit" class="btn-primary btn-save">Save Staff</button></div>
            </form>
        </div>
    </div>

    <div class="form-modal" id="timetableFormModal">
        <div class="form-modal-content">
            <div class="form-modal-header"> <h2 id="timetableModalTitle">New Class Period</h2> <i class="fas fa-times close-form-btn"></i> </div>
            <form id="timetableForm">
                <input type="hidden" id="timetableId">
                <input type="hidden" id="staffEmailForTimetable">
                <div class="form-grid">
                    <div class="form-group"><label>Year</label><select name="year" required><option value="1">1st Year</option><option value="2">2nd Year</option><option value="3">3rd Year</option><option value="4">4th Year</option></select></div>
                    <div class="form-group"><label>Section</label><select name="section" required><option>A</option><option>B</option><option>C</option><option>D</option></select></div>
                    
                    <div class="form-group"><label>Semester</label>
                        <select name="semester" required>
                            <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option>
                            <option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option>
                        </select>
                    </div>

                    <div class="form-group"><label>Department</label>
                        <select name="department" required>
                            <option>Aeronautical Engineering</option><option>Artificial Intelligence & Data Science</option><option>Automobile Engineering</option><option>Biomedical Engineering</option><option>Biotechnology</option><option>Chemical Engineering</option><option>Civil Engineering</option><option>Computer Science and Engineering</option><option>Electrical and Electronics Engineering</option><option>Electronics and Communication Engineering</option><option>Food Technology</option><option>Information Technology</option><option>Mechanical Engineering</option><option>Mechatronics</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Class / Subject Name</label><input type="text" name="class_name" required></div>
                    
                    <div class="form-group"><label>Course Code</label><input type="text" name="course_code" placeholder="e.g., 19CS704" required></div>

                    <div class="form-group"><label>Day of Week</label><select name="day_of_week" required><option>Monday</option><option>Tuesday</option><option>Wednesday</option><option>Thursday</option><option>Friday</option><option>Saturday</option></select></div>
                    <div class="form-group"><label>Start Time</label><input type="time" name="start_time" required></div>
                    <div class="form-group"><label>End Time</label><input type="time" name="end_time" required></div>

                    <div class="form-group"><label>Period Number</label>
                        <select name="period_number" required>
                            <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option>
                            <option value="5">5</option><option value="6">6</option><option value="7">7</option>
                        </select>
                    </div>
                </div>
                <div class="form-actions"><button type="submit" class="btn-primary btn-save">Save Class</button></div>
            </form>
        </div>
    </div>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const API_URL = 'http://localhost:3001';
        let currentUser = null; 

        // All element selectors
        const sidebar = document.getElementById('sidebar');
        const hamburgerMenu = document.getElementById('hamburger-menu');
        const closeSidebarBtn = document.getElementById('close-sidebar-btn');
        const profileContainer = document.getElementById('profile-container');
        const profileDropdown = document.getElementById('profile-dropdown');
        const navLinks = document.querySelectorAll('.nav-link');
        const pages = document.querySelectorAll('.page');
        const newStudentBtn = document.getElementById('newStudentBtn');
        const newStaffBtn = document.getElementById('newStaffBtn');
        const studentFormModal = document.getElementById('studentFormModal');
        const staffFormModal = document.getElementById('staffFormModal');
        const closeFormBtns = document.querySelectorAll('.close-form-btn');
        const studentForm = document.getElementById('studentForm');
        const staffForm = document.getElementById('staffForm');
        const studentListContainer = document.getElementById('studentListContainer');
        const staffListContainer = document.getElementById('staffListContainer');
        const studentModalTitle = document.getElementById('studentModalTitle');
        const staffModalTitle = document.getElementById('staffModalTitle');
        const userProfileFormContainer = document.getElementById('userProfileFormContainer');
        const editProfileBtn = document.getElementById('editProfileBtn');
        const saveProfileBtn = document.getElementById('saveProfileBtn');
        const welcomeMessage = document.getElementById('welcomeMessage');
        const headerProfilePic = document.getElementById('headerProfilePic');
        const logoutBtn = document.getElementById('logoutBtn');
        
        // Timetable elements
        const staffGridForTimetable = document.getElementById('staffGridForTimetable');
        const staffSelectionView = document.getElementById('staffSelectionView');
        const timetableDetailsView = document.getElementById('timetableDetailsView');
        const selectedStaffName = document.getElementById('selectedStaffName');
        const newTimetableBtn = document.getElementById('newTimetableBtn');
        const weeklyTimetableContainer = document.getElementById('weeklyTimetableContainer');
        const timetableFormModal = document.getElementById('timetableFormModal');
        const timetableForm = document.getElementById('timetableForm');
        const timetableModalTitle = document.getElementById('timetableModalTitle');
        const backToStaffListBtn = document.getElementById('backToStaffListBtn');

        function loadUserData() {
            const userDataString = localStorage.getItem('loggedInUser');
            if (userDataString) {
                currentUser = JSON.parse(userDataString);
                if (welcomeMessage) { welcomeMessage.textContent = `Welcome back, ${currentUser.name}`; }
                if (headerProfilePic && currentUser.profile_picture_url) {
                    headerProfilePic.src = `${API_URL}${currentUser.profile_picture_url}`;
                } else if (headerProfilePic) {
                    headerProfilePic.src = 'https://i.pravatar.cc/150?u=default';
                }
            } else {
                alert('You are not logged in. Redirecting to login page.');
                window.location.href = 'login.html';
            }
        }

        const toggleSidebar = () => sidebar.classList.toggle('active');
        hamburgerMenu.addEventListener('click', toggleSidebar);
        closeSidebarBtn.addEventListener('click', toggleSidebar);
        profileContainer.addEventListener('click', (e) => { e.stopPropagation(); profileDropdown.classList.toggle('active'); });
        document.addEventListener('click', (e) => {
             if (!profileContainer.contains(e.target)) {
                profileDropdown.classList.remove('active');
            }
        });

        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const targetLink = e.target.closest('.nav-link');
                if (!targetLink) return;
                const pageId = targetLink.getAttribute('data-page');
                pages.forEach(p => p.classList.remove('active'));
                const targetPage = document.getElementById(pageId);
                if(targetPage) {
                    targetPage.classList.add('active');
                }
                navLinks.forEach(l => l.classList.remove('active'));
                if (!targetLink.classList.contains('back-button')) {
                    targetLink.classList.add('active');
                }
                
                if(pageId === 'manage-timetables') {
                    staffSelectionView.style.display = 'block';
                    timetableDetailsView.style.display = 'none';
                    displayStaffListForTimetable();
                }
                if(pageId === 'manage-students') fetchAndDisplayStudents();
                if(pageId === 'manage-staff') fetchAndDisplayStaff();
                if(pageId === 'user-profile') loadUserProfile();
                
                if (sidebar.classList.contains('active')) {
                    sidebar.classList.remove('active');
                }
            });
        });

        logoutBtn.addEventListener('click', (e) => {
            e.preventDefault();
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('loggedInUser');
                window.location.href = 'login.html';
            }
        });

        const apiCall = async (endpoint, method = 'GET', body = null) => {
            try {
                const options = { method, headers: { 'Content-Type': 'application/json' } };
                if (body) { options.body = JSON.stringify(body); }
                const response = await fetch(`${API_URL}/api${endpoint}`, options);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Something went wrong');
                }
                return response.json();
            } catch (error) {
                console.error('API Call Error:', error);
                alert(`Error: ${error.message}`);
                return null;
            }
        };
        
        const fetchAndDisplayStudents = async () => {
            const data = await apiCall('/admin/students');
            if (!data || !data.students) { studentListContainer.innerHTML = '<p>No students found.</p>'; return; }
            let tableHTML = `<table class="data-table"><thead><tr><th>Name</th><th>Register No</th><th>Department</th><th>Year</th><th>Actions</th></tr></thead><tbody>`;
            data.students.forEach(student => {
                tableHTML += `<tr><td>${student.student_name}</td><td>${student.register_number}</td><td>${student.department}</td><td>${student.year_of_study}</td><td class="action-icons"><i class="fas fa-edit edit-student-btn" data-id="${student.id}"></i><i class="fas fa-trash-alt delete-student-btn" data-id="${student.id}"></i></td></tr>`;
            });
            tableHTML += `</tbody></table>`;
            studentListContainer.innerHTML = tableHTML;
        };
        const openStudentModal = (student = null) => {
            studentForm.reset();
            document.getElementById('studentId').value = '';
            const modalTitle = studentFormModal.querySelector('h2');
            if (student) {
                modalTitle.textContent = 'Edit Student Details';
                document.getElementById('studentId').value = student.id;
                for (const key in student) { if (studentForm.elements[key]) { studentForm.elements[key].value = student[key]; } }
            } else {
                modalTitle.textContent = 'New Student Entry';
            }
            studentFormModal.classList.add('active');
        };
        newStudentBtn.addEventListener('click', () => openStudentModal());
        studentListContainer.addEventListener('click', async (e) => {
            const target = e.target;
            if (target.classList.contains('edit-student-btn')) {
                const studentId = target.dataset.id;
                const data = await apiCall(`/admin/students/${studentId}`);
                if (data && data.student) { openStudentModal(data.student); }
            } else if (target.classList.contains('delete-student-btn')) {
                const studentId = target.dataset.id;
                if (confirm('Are you sure?')) {
                    const result = await apiCall(`/admin/students/${studentId}`, 'DELETE');
                    if (result) { alert(result.message); fetchAndDisplayStudents(); }
                }
            }
        });
        studentForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            const formData = new FormData(studentForm);
            const studentData = Object.fromEntries(formData.entries());
            const studentId = studentData.studentId;
            let result;
            if (studentId) { result = await apiCall(`/admin/students/${studentId}`, 'PUT', { studentData }); } 
            else { result = await apiCall('/admin/students', 'POST', { studentData }); }
            if (result) { alert(result.message); studentFormModal.classList.remove('active'); fetchAndDisplayStudents(); }
        });
        
        const fetchAndDisplayStaff = async () => {
            const data = await apiCall('/admin/staff');
            if (!data || !data.staff) { staffListContainer.innerHTML = '<p>No staff found.</p>'; return; }
            let tableHTML = `<table class="data-table"><thead><tr><th>Name</th><th>Email</th><th>Department</th><th>Role</th><th>Status</th><th>Actions</th></tr></thead><tbody>`;
            data.staff.forEach(staff => {
                const fullName = `${staff.prefix || ''} ${staff.first_name} ${staff.last_name || ''}`.trim();
                tableHTML += `<tr><td>${fullName}</td><td>${staff.email || 'N/A'}</td><td>${staff.department}</td><td>${staff.role || 'N/A'}</td><td>${staff.profile_status}</td><td class="action-icons"><i class="fas fa-edit edit-staff-btn" data-id="${staff.id}"></i><i class="fas fa-trash-alt delete-staff-btn" data-id="${staff.id}"></i></td></tr>`;
            });
            tableHTML += `</tbody></table>`;
            staffListContainer.innerHTML = tableHTML;
        };
        const openStaffModal = (staff = null) => {
            staffForm.reset();
            document.getElementById('staffId').value = '';
            const modalTitle = staffFormModal.querySelector('h2');
            const passwordField = staffForm.querySelector('input[name="password"]');
            if (staff) {
                modalTitle.textContent = 'Edit Staff Details';
                document.getElementById('staffId').value = staff.id;
                passwordField.removeAttribute('required');
                passwordField.placeholder = "Leave blank to keep unchanged";
                for (const key in staff) {
                    if (key === 'date_of_birth' && staff[key]) { staffForm.elements[key].value = staff[key].split('T')[0]; } 
                    else if (staffForm.elements[key]) { staffForm.elements[key].value = staff[key]; }
                }
            } else {
                modalTitle.textContent = 'New Staff Entry';
                passwordField.setAttribute('required', 'required');
                passwordField.placeholder = "";
            }
            staffFormModal.classList.add('active');
        };
        newStaffBtn.addEventListener('click', () => openStaffModal());
        staffListContainer.addEventListener('click', async (e) => {
            const target = e.target;
            if (target.classList.contains('edit-staff-btn')) {
                const staffId = target.dataset.id;
                const data = await apiCall(`/admin/staff/${staffId}`);
                if (data && data.staff) { openStaffModal(data.staff); }
            } else if (target.classList.contains('delete-staff-btn')) {
                const staffId = target.dataset.id;
                if (confirm('Are you sure?')) {
                    const result = await apiCall(`/admin/staff/${staffId}`, 'DELETE');
                    if (result) { alert(result.message); fetchAndDisplayStaff(); }
                }
            }
        });
        staffForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            const formData = new FormData(staffForm);
            const staffData = Object.fromEntries(formData.entries());
            const staffId = staffData.staffId;
            if (!staffData.user_name) { staffData.user_name = staffData.email; }
            let result;
            if (staffId) { result = await apiCall(`/admin/staff/${staffId}`, 'PUT', { staffData }); } 
            else { result = await apiCall('/admin/staff', 'POST', { staffData }); }
            if (result) { alert(result.message); staffFormModal.classList.remove('active'); fetchAndDisplayStaff(); }
        });
        
        const loadUserProfile = async () => {
            if (!currentUser || !currentUser.id) { userProfileFormContainer.innerHTML = '<p>Could not load user profile. User ID is missing.</p>'; return; }
            const data = await apiCall(`/admin/staff/${currentUser.id}`);
            if (!data || !data.staff) { userProfileFormContainer.innerHTML = '<p>Could not load user profile details.</p>'; return; }
            const user = data.staff;
            const fullName = `${user.prefix || ''} ${user.first_name} ${user.last_name || ''}`.trim();
            const profilePicture = user.profile_picture_url ? `${API_URL}${user.profile_picture_url}` : 'https://i.pravatar.cc/150?u=default';
            const formHTML = `<form id="profileForm"><input type="hidden" name="userId" value="${user.id}"><div class="profile-grid"><div class="profile-picture-section"><img src="${profilePicture}" alt="Profile Picture" id="profileImagePreview"><label for="profilePictureUpload" class="btn-primary btn-upload" style="display:none;"><i class="fas fa-upload"></i> Upload</label><input type="file" name="profile_picture" id="profilePictureUpload" accept="image/*"></div><div class="profile-fields-section"><div class="form-grid"><div class="form-group"><label>Full Name</label><input type="text" value="${fullName}" readonly></div><div class="form-group"><label>Email / Username</label><input type="text" value="${user.email || 'N/A'}" readonly></div><div class="form-group"><label>Role</label><input type="text" value="${user.role || 'N/A'}" readonly></div><div class="form-group"><label>New Password</label><input type="password" name="password" id="passwordField" placeholder="Enter new password to change" readonly></div></div></div></div></form>`;
            userProfileFormContainer.innerHTML = formHTML;
            document.getElementById('profilePictureUpload').addEventListener('change', function(e) {
                if (e.target.files && e.target.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(event) { document.getElementById('profileImagePreview').setAttribute('src', event.target.result); }
                    reader.readAsDataURL(e.target.files[0]);
                }
            });
        };
        editProfileBtn.addEventListener('click', () => {
            document.getElementById('passwordField').readOnly = false;
            document.querySelector('.btn-upload').style.display = 'inline-flex';
            editProfileBtn.style.display = 'none';
            saveProfileBtn.style.display = 'inline-flex';
        });
        saveProfileBtn.addEventListener('click', async () => {
            const form = document.getElementById('profileForm');
            const userId = form.elements['userId'].value;
            const newPassword = form.elements['password'].value;
            const pictureFile = document.getElementById('profilePictureUpload').files[0];
            let passwordChanged = false, pictureChanged = false;
            if (newPassword) {
                const result = await apiCall(`/profile/${userId}`, 'PATCH', { password: newPassword });
                if (result && result.success) { passwordChanged = true; }
            }
            if (pictureFile) {
                const formData = new FormData();
                formData.append('profile_picture', pictureFile);
                try {
                    const response = await fetch(`${API_URL}/api/profile/${userId}/picture`, { method: 'POST', body: formData });
                    const data = await response.json();
                    if (data.success) {
                        currentUser.profile_picture_url = data.filePath;
                        localStorage.setItem('loggedInUser', JSON.stringify(currentUser));
                        pictureChanged = true;
                    } else { alert('Picture upload failed: ' + data.message); }
                } catch (error) { alert('An error occurred during picture upload.'); }
            }
            if (passwordChanged || pictureChanged) {
                alert('Profile updated successfully!');
                loadUserData(); 
                loadUserProfile();
            } else { alert("No changes were made."); }
            document.getElementById('passwordField').readOnly = true;
            document.querySelector('.btn-upload').style.display = 'none';
            editProfileBtn.style.display = 'inline-flex';
            saveProfileBtn.style.display = 'none';
        });
        
        closeFormBtns.forEach(btn => {
            btn.addEventListener('click', () => btn.closest('.form-modal').classList.remove('active'));
        });

        async function displayStaffListForTimetable() {
            const data = await apiCall('/admin/staff-list');
            staffGridForTimetable.innerHTML = '';
            if (data && data.staffList) {
                data.staffList.forEach(staff => {
                    const staffCard = document.createElement('div');
                    staffCard.className = 'staff-card';
                    staffCard.dataset.email = staff.email;
                    staffCard.dataset.name = staff.name;
                    staffCard.innerHTML = `<i class="fas fa-chalkboard-teacher"></i><h4>${staff.name}</h4><p>${staff.email}</p>`;
                    staffGridForTimetable.appendChild(staffCard);
                });
            }
        }
        
        // MODIFIED: This function is updated to show the new timetable details
        async function displayWeeklyTimetable(staffEmail, staffName) {
            staffSelectionView.style.display = 'none';
            timetableDetailsView.style.display = 'block';
            selectedStaffName.textContent = `Timetable for ${staffName}`;
            document.getElementById('staffEmailForTimetable').value = staffEmail;
            
            const data = await apiCall(`/admin/timetables/${staffEmail}`);
            weeklyTimetableContainer.innerHTML = '';
            let tableHTML = '<table class="data-table">';
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            days.forEach(day => {
                tableHTML += `<thead><tr><th colspan="6" style="background-color: #e9ecef;">${day}</th></tr></thead>`;
                const periodsForDay = data && data.timetable ? data.timetable.filter(p => p.day_of_week === day).sort((a, b) => a.start_time.localeCompare(b.start_time)) : [];
                
                if (periodsForDay.length > 0) {
                    tableHTML += '<thead><tr><th>Time</th><th>Period</th><th>Subject Name</th><th>Course Code</th><th>Class Details</th><th>Actions</th></tr></thead><tbody>';
                    periodsForDay.forEach(period => {
                        tableHTML += `<tr>
                            <td>${period.start_time.substring(0,5)} - ${period.end_time.substring(0,5)}</td>
                            <td>${period.period_number || '-'}</td>
                            <td>${period.class_name}</td>
                            <td>${period.course_code || 'N/A'}</td>
                            <td>${period.department}<br><small style="color:#555;">Sem ${period.semester || '-'} - Sec ${period.section}</small></td>
                            <td class="action-icons">
                                <i class="fas fa-edit edit-period-btn" data-period='${JSON.stringify(period)}'></i>
                                <i class="fas fa-trash-alt delete-period-btn" data-id="${period.id}"></i>
                            </td>
                        </tr>`;
                    });
                    tableHTML += '</tbody>';
                } else {
                    tableHTML += `<tbody><tr><td colspan="6">No classes scheduled.</td></tr></tbody>`;
                }
            });
            tableHTML += '</table>';
            weeklyTimetableContainer.innerHTML = tableHTML;
        }
        
        staffGridForTimetable.addEventListener('click', (e) => {
            const card = e.target.closest('.staff-card');
            if (card) {
                displayWeeklyTimetable(card.dataset.email, card.dataset.name);
            }
        });

        backToStaffListBtn.addEventListener('click', () => {
            staffSelectionView.style.display = 'block';
            timetableDetailsView.style.display = 'none';
        });

        // MODIFIED: This function is updated to handle the new form fields
        function openTimetableModal(periodData = null) {
            timetableForm.reset();
            document.getElementById('timetableId').value = '';
            const modalTitle = timetableFormModal.querySelector('h2');
            if (periodData) {
                modalTitle.textContent = "Edit Class Period";
                document.getElementById('timetableId').value = periodData.id;
                timetableForm.elements['year'].value = periodData.year;
                timetableForm.elements['section'].value = periodData.section;
                timetableForm.elements['department'].value = periodData.department;
                timetableForm.elements['class_name'].value = periodData.class_name;
                timetableForm.elements['day_of_week'].value = periodData.day_of_week;
                timetableForm.elements['start_time'].value = periodData.start_time;
                timetableForm.elements['end_time'].value = periodData.end_time;

                // Populating new fields for editing
                timetableForm.elements['course_code'].value = periodData.course_code;
                timetableForm.elements['semester'].value = periodData.semester;
                timetableForm.elements['period_number'].value = periodData.period_number;

            } else {
                modalTitle.textContent = "New Class Period";
            }
            timetableFormModal.classList.add('active');
        }
        newTimetableBtn.addEventListener('click', () => openTimetableModal());
        
        timetableForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const timetableId = document.getElementById('timetableId').value;
            const staffEmail = document.getElementById('staffEmailForTimetable').value;
            const formData = new FormData(timetableForm);
            const data = Object.fromEntries(formData.entries());
            data.staff_email = staffEmail;
            // No changes needed here, the form data is collected automatically
            const result = timetableId ? await apiCall(`/admin/timetables/${timetableId}`, 'PUT', data) : await apiCall('/admin/timetables', 'POST', data);
            if (result && result.success) {
                alert(result.message);
                timetableFormModal.classList.remove('active');
                displayWeeklyTimetable(staffEmail, selectedStaffName.textContent.replace('Timetable for ', ''));
            }
        });
        
        weeklyTimetableContainer.addEventListener('click', async (e) => {
            const target = e.target;
            if (target.classList.contains('edit-period-btn')) {
                const periodData = JSON.parse(target.dataset.period);
                openTimetableModal(periodData);
            }
            if (target.classList.contains('delete-period-btn')) {
                const periodId = target.dataset.id;
                if (confirm('Are you sure?')) {
                    const result = await apiCall(`/admin/timetables/${periodId}`, 'DELETE');
                    if (result && result.success) {
                        alert(result.message);
                        const staffEmail = document.getElementById('staffEmailForTimetable').value;
                        displayWeeklyTimetable(staffEmail, selectedStaffName.textContent.replace('Timetable for ', ''));
                    }
                }
            }
        });
        
        loadUserData();
    });
    </script>
</body>
</html>